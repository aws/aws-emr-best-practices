
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-7.1.4">
    
    
      
        <title>Troubleshooting and Tuning - EMR Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#52-spark-troubleshooting-and-performance-tuning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="EMR Best Practices Guides" class="md-header__button md-logo" aria-label="EMR Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EMR Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Troubleshooting and Tuning
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws/aws-emr-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-emr-best-practices
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="EMR Best Practices Guides" class="md-nav__button md-logo" aria-label="EMR Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    EMR Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws/aws-emr-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-emr-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        1 - Cost Optimizations
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="1 - Cost Optimizations" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          1 - Cost Optimizations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        2 - Reliability
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="2 - Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          2 - Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        3 - Security
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="3 - Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          3 - Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../security/best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        4 - Features
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="4 - Features" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          4 - Features
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/managed_scaling/best_practices/" class="md-nav__link">
        4.1 - Managed Scaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/spot_usage/best_practices/" class="md-nav__link">
        4.2 - Spot Usage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      <label class="md-nav__link" for="__nav_6">
        5 - Applications
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="5 - Applications" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          5 - Applications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" checked>
      
      <label class="md-nav__link" for="__nav_6_1">
        5.1 Spark
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="5.1 Spark" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          5.1 Spark
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Troubleshooting and Tuning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Troubleshooting and Tuning
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#521-spark-structured-streaming-applications-have-high-connection-create-rate-to-amazon-msk" class="md-nav__link">
    5.2.1  -  Spark Structured Streaming applications have high Connection Create Rate to Amazon MSK
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#522-sparkdrivermaxresultsize-error-on-an-emr-heterogeneous-cluster-but-the-driver-is-not-collecting-data" class="md-nav__link">
    5.2.2 - spark.driver.maxResultSize error on an EMR heterogeneous cluster but the driver is not collecting data
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      <label class="md-nav__link" for="__nav_6_2">
        5.2 Hive
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="5.2 Hive" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          5.2 Hive
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hive/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hive/best_practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      <label class="md-nav__link" for="__nav_6_3">
        5.3 HBase
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="5.3 HBase" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          5.3 HBase
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/best_practice/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/best_practice_hdfs/" class="md-nav__link">
        Best Practice for HDFS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/best_practice_s3/" class="md-nav__link">
        Best Practice for Amazon S3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/data_integrity/" class="md-nav__link">
        Data Integrity
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/data_migration/" class="md-nav__link">
        Data Migration
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/management/" class="md-nav__link">
        Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/observability/" class="md-nav__link">
        Observability
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/performance_tests/" class="md-nav__link">
        Performance Tests
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hbase/security/" class="md-nav__link">
        Security
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        6 - Architecture
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="6 - Architecture" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          6 - Architecture
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_1" type="checkbox" id="__nav_7_1" >
      
      <label class="md-nav__link" for="__nav_7_1">
        Ad Hoc
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Ad Hoc" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_1">
          <span class="md-nav__icon md-icon"></span>
          Ad Hoc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/adhoc/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/adhoc/architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        7 - Benchmarking Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="7 - Benchmarking Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          7 - Benchmarking Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_1" type="checkbox" id="__nav_8_1" >
      
      <label class="md-nav__link" for="__nav_8_1">
        Introduction
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Introduction" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/introduction/purpose/" class="md-nav__link">
        Purpose
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/introduction/price_performance/" class="md-nav__link">
        Price Performance
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/introduction/benchmarking_variables/" class="md-nav__link">
        Benchmarking Variables
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2" type="checkbox" id="__nav_8_2" >
      
      <label class="md-nav__link" for="__nav_8_2">
        Planning
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Planning" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Planning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/planning/selecting_workloads.md" class="md-nav__link">
        Selecting Workloads to Benchmark
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/planning/experiment_configs.md" class="md-nav__link">
        Deciding on Experiment Configs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/planning/performance_metrics.md" class="md-nav__link">
        Performance Metrics
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_3" type="checkbox" id="__nav_8_3" >
      
      <label class="md-nav__link" for="__nav_8_3">
        Running
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Running" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          Running
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/running/setting_up_environment/" class="md-nav__link">
        Setting Up the Benchmark Environment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/running/benchmarking_checklist/" class="md-nav__link">
        Benchmark Checklist
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_4" type="checkbox" id="__nav_8_4" >
      
      <label class="md-nav__link" for="__nav_8_4">
        Analyzing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Analyzing" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_4">
          <span class="md-nav__icon md-icon"></span>
          Analyzing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/analyzing/calculate_cost/" class="md-nav__link">
        How to Calculate Costs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/analyzing/retrieve_event_logs/" class="md-nav__link">
        How to retrieve the Spark Event Logs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/analyzing/read_spark_UI/" class="md-nav__link">
        How to Read the Spark Web UI / Spark History Server
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_5" type="checkbox" id="__nav_8_5" >
      
      <label class="md-nav__link" for="__nav_8_5">
        Scenarios
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Scenarios" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_5">
          <span class="md-nav__icon md-icon"></span>
          Scenarios
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/scenarios/otf_comparison.md" class="md-nav__link">
        OTF Comparison
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmarking/scenarios/streaming.md" class="md-nav__link">
        Streaming
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#521-spark-structured-streaming-applications-have-high-connection-create-rate-to-amazon-msk" class="md-nav__link">
    5.2.1  -  Spark Structured Streaming applications have high Connection Create Rate to Amazon MSK
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#522-sparkdrivermaxresultsize-error-on-an-emr-heterogeneous-cluster-but-the-driver-is-not-collecting-data" class="md-nav__link">
    5.2.2 - spark.driver.maxResultSize error on an EMR heterogeneous cluster but the driver is not collecting data
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws/aws-emr-best-practices/edit/master/docs/applications/spark/troubleshooting_and_tuning.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="52-spark-troubleshooting-and-performance-tuning"><strong>5.2 - Spark troubleshooting and performance tuning</strong><a class="headerlink" href="#52-spark-troubleshooting-and-performance-tuning" title="Permanent link">&para;</a></h1>
<h2 id="521-spark-structured-streaming-applications-have-high-connection-create-rate-to-amazon-msk"><strong>5.2.1  -  Spark Structured Streaming applications have high Connection Create Rate to Amazon MSK</strong><a class="headerlink" href="#521-spark-structured-streaming-applications-have-high-connection-create-rate-to-amazon-msk" title="Permanent link">&para;</a></h2>
<p><strong>Symptom</strong>: Amazon MSK cluster has high CPU usage and MSK metrics indicate high connection create rate to the cluster.</p>
<p><strong>Analysis</strong>: By default, Spark Structured Streaming Kafka connector has a 1:1 mapping relation of MSK TopicPartitions to Spark tasks. Between micro batches, Spark tries to (best effort) assign the same MSK TopicPartitions to the same executors which in turn reuses the Kafka consumers and connections. </p>
<p>Spark Structured Streaming Kafka connector has an option <code>minPartitions</code> which can divide large TopicPartitions to smaller pieces. When <code>minPartitions</code> is set to a value larger than the number of TopicPartitions,  Spark creates tasks based on <code>minPartitions</code> to increase parallelism (the number of Spark tasks will be approximately <code>minPartition</code>). </p>
<ul>
<li>As 1:1 mapping doesn't exist anymore, Spark executors are randomly assigned to process any TopicPartition OffsetRanges. An executor processed TopicPartition X can be assigned to process TopicPartition Y in next micro batch.  A new Kafka consumer/connection needs to be created if Y is on another MSK broker.</li>
<li>One Spark executor can be assigned to process multiple Spark tasks with the same MSK TopicPartition on different OffsetRanges.  And in Spark 2.x, Kafka consumer cache is disabled when multiple tasks in the same executor read the same TopicPartitions . </li>
</ul>
<p>Setting <code>minPartitions</code> comes at a cost of initializing Kakfa consumers at each micro batch. This may impact performance especially when using SSL. </p>
<p>A test was run with following test environment:</p>
<p><strong>Kafka version 2.8.1</strong></p>
<ul>
<li>3 kafka.m5.xlarge instances</li>
<li>test kafka topic has 10 partitions</li>
<li>only SASL/SCRAM authentication enabled</li>
</ul>
<p><strong>EMR 5.36 (Spark 2.4.8)  cluster</strong></p>
<ul>
<li>30 core nodes - EC2 m5.4xlarge</li>
</ul>
<p>Spark Structured Streaming test application has 5 cores 5G memory for each executor.</p>
<p>Below figure shows the test result of different <code>minPartitions</code> values with MSK’s ConnectionCreationRate and CPUUser usages. As shown in the test result, higher ConnectionCreationRate is related to higher CPU usage.</p>
<p>Test1: 50 minPartitions 16:40-17:30<br />
Test2: 100 minPartitions 18:00-18:35<br />
Test3: 200 minPartitions 19:00-19:35<br />
Test4: no minPartitions 20:06 - 20:30  </p>
<p><img alt="ConnectionCreationRate" src="../images/spark-tt-1.png" /></p>
<p><strong>Recommendation</strong>: </p>
<ol>
<li>
<p>Upgrade to the latest EMR version (spark 3.x) to use Sparks <a href="https://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html#consumer-caching">consumer pool cache</a> feature. This feature allows Spark to cache more than one Kafka consumer with same MSK TopicPartition at each executor, and reuse the consumers in later micro batches. This will allow you to set <code>minPartitions</code> while reduce the ConnectionCreationRate.</p>
</li>
<li>
<p>On EMR 5.x (Spark 2.x), only set min partitions when needed - for example, if you have data skew or if your stream is falling behind. Min partitions will allow you to increase parallelism and process records faster but at the expense of high connection rates and CPU.  </p>
</li>
</ol>
<h2 id="522-sparkdrivermaxresultsize-error-on-an-emr-heterogeneous-cluster-but-the-driver-is-not-collecting-data"><strong>5.2.2 - spark.driver.maxResultSize error on an EMR heterogeneous cluster but the driver is not collecting data</strong><a class="headerlink" href="#522-sparkdrivermaxresultsize-error-on-an-emr-heterogeneous-cluster-but-the-driver-is-not-collecting-data" title="Permanent link">&para;</a></h2>
<p><strong>Symptom</strong>: Spark jobs fail from time to time and below error is seen in the log:</p>
<p><code>22/08/22 14:14:24 ERROR FileFormatWriter: Aborting job f6913a46-d2d8-46f0-a545-2d2ba938b113. org.apache.spark.SparkException: Job aborted due to stage failure: Total size of serialized results of 179502 tasks (1024.0 MB) is bigger than spark.driver.maxResultSize (1024.0 MB) at org.apache.spark.scheduler.DAGScheduler.org$apache$spark$scheduler$DAGScheduler$$failJobAndIndependentStages(DAGScheduler.scala:2171)</code></p>
<p>By setting <code>spark.driver.maxResultSize</code> to 0(unlimited), the error is gone.  But the Spark job is not collecting data to driver, how can the result returning to driver exceed 1024MB? </p>
<p><strong>Analysis</strong>:  Each finished task sends a serialized <code>WriteTaskResult</code> object to driver. The object size is usually several kilobytes, e.g.</p>
<p><code>22/09/06 22:24:18 INFO Executor: Finished task 0.0 in stage 3.0 (TID 3). 5192 bytes result sent to driver</code></p>
<p>From the log, we can see there are 179502 (or more) tasks. For such a number of tasks, the total result size can exceed 1024MB for serialized <code>WriteTaskResult</code> objects only.</p>
<p>The job is reading parquet files from S3 and the input folder has 3.5K parquet files with average size ~116MB per file. As default <code>spark.sql.files.maxPartitionBytes</code> is 128M, so approximately one file to one Spark task.  The job's processing logic further splits one task to ~11 tasks. Total tasks should be 3.5K * 11 = 38.5K. But why there are 179502 (or more) tasks?</p>
<p>To find root cause, we need to understand how Spark SQL decides the max size of a partition for non-bucketed splittable files.</p>
<p>Spark2 is following below formula (Spark3 has a slightly different formula which is described later)</p>
<p><code>maxSplitBytes = Math.min(defaultMaxSplitBytes, Math.max(openCostInBytes, bytesPerCore))</code></p>
<p><code>maxSplitBytes</code> is the max bytes per partition.</p>
<p><code>defaultMaxSplitBytes</code> is from <code>spark.sql.files.maxPartitionBytes</code> whose default value is 128M.</p>
<p><code>openCostInBytes</code>  is from <code>spark.sql.files.openCostInBytes</code> whose default value is 4M.</p>
<p><code>bytesPerCore</code> = (Sum of all data file size + num of file * <code>openCostInBytes</code> ) / <code>defaultParallelism</code></p>
<p><code>defaultParallelism</code>’s default value is total number of virtual cores running the job.  It can also be set to a value by defining <code>spark.default.parallelism</code>.</p>
<p>When there are a large number of virtual cores allocated to the Spark job by Yarn, <code>maxSplitBytes</code> can be smaller than <code>defaultMaxSplitBytes</code>, i.e. more tasks will be created.  For this case, from Spark UI, we know total number of vcores is 15837, i.e. <code>defaultParallelism</code> is 15837
<img alt="SparkUITotalCores" src="../images/spark-tt-2.png" /></p>
<p><code>bytesPerCore</code> = (116M * 3500 + 4M * 3500)/15837 = 26.5M</p>
<p><code>maxSplitBytes</code> = min(128M, max(4M, 26.5M)) = 26.5M.  So one 116M parquet file is split into 4~5 Spark tasks.  3.5K * 11 * 5 = 192.5K -- that's why there were 179502 (or more) tasks.</p>
<p>Note that the vcore count is based on Yarn containers, not physical cores.  As Yarn’s default container allocation is based on available memory, this means there can be vcore over subscriptions in a heterogeneous EMR cluster.</p>
<p>For example, if we have a heterogeneous EMR cluster as below:</p>
<p>Core Node: c5.12xlarge(48cores/96GB) — Memory allocated to Yarn: 90112MB<br />
Task Node: r5.8xlarge(32cores/256GB) — Memory allocated to Yarn: 253952MB</p>
<p>The default EMR executor size is based on core node instance type. In this example, for c5.12xlarge, default executor size is 3 cores 4743M memory. Default <code>spark.yarn.executor.memoryOverheadFactor</code> is 0.1875.  A Yarn container has 3 cores, 4743MB*(1+0.1875)= 5632MB memory.</p>
<p>On c5.12xlarge, Yarn can allocate 16 conatainers with 48 vcores in total:<br />
90112MB/5632MB = 16 containers * 3 core = 48 vcores</p>
<p>While on r5.8xlarge, Yarn can allocate 45 containers with 135 vcores in total:<br />
253952MB/5632MB = 45 containers * 3 core = 135 vcores - 32cores = 103 vcore oversubscription</p>
<p><strong>Recommendation</strong>: When Spark reads splittable files, <code>maxSplitBytes</code> can be smaller than <code>spark.sql.files.maxPartitionBytes</code> if there are a big number of vcores allocated to the job.  Use the formula described here to set <code>spark.default.parallelism</code> value properly and have a reasonable <code>maxSplitBytes</code>. </p>
<p><strong>Spark 3</strong></p>
<p>Spark 3 provides more options to control<code>maxSplitBytes</code> as below </p>
<div class="codehilite"><pre><span></span><code>  <span class="k">def</span> <span class="n">maxSplitBytes</span><span class="o">(</span>
      <span class="n">sparkSession</span><span class="k">:</span> <span class="kt">SparkSession</span><span class="o">,</span>
      <span class="n">selectedPartitions</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">PartitionDirectory</span><span class="o">])</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">defaultMaxSplitBytes</span> <span class="o">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">sessionState</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">filesMaxPartitionBytes</span>
    <span class="k">val</span> <span class="n">openCostInBytes</span> <span class="o">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">sessionState</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">filesOpenCostInBytes</span>
    <span class="k">val</span> <span class="n">minPartitionNum</span> <span class="o">=</span> <span class="n">sparkSession</span><span class="o">.</span><span class="n">sessionState</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">filesMinPartitionNum</span>
      <span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">sparkSession</span><span class="o">.</span><span class="n">leafNodeDefaultParallelism</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">totalBytes</span> <span class="o">=</span> <span class="n">selectedPartitions</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">getLen</span> <span class="o">+</span> <span class="n">openCostInBytes</span><span class="o">)).</span><span class="n">sum</span>
    <span class="k">val</span> <span class="n">bytesPerCore</span> <span class="o">=</span> <span class="n">totalBytes</span> <span class="o">/</span> <span class="n">minPartitionNum</span>

    <span class="nc">Math</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="n">defaultMaxSplitBytes</span><span class="o">,</span> <span class="nc">Math</span><span class="o">.</span><span class="n">max</span><span class="o">(</span><span class="n">openCostInBytes</span><span class="o">,</span> <span class="n">bytesPerCore</span><span class="o">))</span>
  <span class="o">}</span>
</code></pre></div>

<p><code>filesMinPartitionNum</code> is from <code>spark.sql.files.minPartitionNum</code>. It is the suggested (not guaranteed) minimum number of split file partitions. If not set, the default value is <code>spark.default.parallelism</code>.</p>
<p><code>leafNodeDefaultParallelism</code> is from <code>spark.sql.leafNodeDefaultParallelism</code>. It is the default parallelism of Spark SQL leaf nodes.</p>
<p>Setting either of the above two parameters has the same effect as <code>spark.default.parallelism</code> on <code>maxSplitBytes</code>.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../best_practices/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Best Practices
            </div>
          </div>
        </a>
      
      
        <a href="../../hive/introduction/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Introduction
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs"], "search": "../../../assets/javascripts/workers/search.4fa0e4ee.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.1d3bfcf1.min.js"></script>
      
    
  </body>
</html>