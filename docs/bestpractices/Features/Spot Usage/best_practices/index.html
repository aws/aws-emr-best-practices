<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-bestpractices/Features/Spot Usage/best_practices" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">4.2 - Spot Usage | AWS Open Data Analytics</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" name="twitter:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" property="og:url" content="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="4.2 - Spot Usage | AWS Open Data Analytics"><meta data-rh="true" name="description" content="BP 4.2.1 When to use spot vs. on demand"><meta data-rh="true" property="og:description" content="BP 4.2.1 When to use spot vs. on demand"><link data-rh="true" rel="icon" href="/aws-emr-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices" hreflang="x-default"><link rel="stylesheet" href="/aws-emr-best-practices/assets/css/styles.7a6c5961.css">
<script src="/aws-emr-best-practices/assets/js/runtime~main.63e43d74.js" defer="defer"></script>
<script src="/aws-emr-best-practices/assets/js/main.e11bb194.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aws-emr-best-practices/"><div class="navbar__logo"><img src="/aws-emr-best-practices/img/logo.svg" alt="AWS Open Data Analytics" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/aws-emr-best-practices/img/logo.svg" alt="AWS Open Data Analytics" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS Open Data Analytics</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aws-emr-best-practices/docs/bestpractices/">Best Practices</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/benchmarks/introduction">Benchmarks</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/utilities/">Utilities</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/migration/introduction">Migration</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aws-emr-best-practices/docs/bestpractices/">EMR Best Practices Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/Introduction">Cost Optimizations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Reliability/introduction">Reliability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Security/introduction">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/aws-emr-best-practices/docs/bestpractices/Features/Managed Scaling/best_practices">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Features/Managed Scaling/best_practices">Managed Scaling</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices">Spot Usage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Features/Spot Usage/best_practices">Best Practices</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Applications/Hbase/introduction">Applications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Architecture/Adhoc/introduction">Architecture</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aws-emr-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Features</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spot Usage</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Best Practices</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>4.2 - Spot Usage</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-421-when-to-use-spot-vs-on-demand">BP 4.2.1 When to use spot vs. on demand<a href="#bp-421-when-to-use-spot-vs-on-demand" class="hash-link" aria-label="Direct link to BP 4.2.1 When to use spot vs. on demand" title="Direct link to BP 4.2.1 When to use spot vs. on demand">​</a></h2>
<p>Spot Instances provide a great way to help reduce costs. However, there are certain scenarios where you should consider on demand because there&#x27;s always a chance that a Spot interruption can happen. The considerations are:</p>
<ul>
<li>Use Spot for workloads where they can be interrupted and resumed (interruption rates are extremely low), or workloads that can exceed an SLA</li>
<li>Use Spot for testing and development workloads or when testing testing new applications.</li>
<li>Avoid Spot if your workload requires predictable completion time or has service level agreement (SLA) requirements</li>
<li>Avoid Spot if your workload has 0 fault tolerance or when recomputing tasks are expensive</li>
<li>Use Instance Fleet with allocation strategy while using Spot so that you can diversify across many different instances. The Spot capacity pool can be unpredictable, so diversifying with as many instances that meets your requirements can help increase the likelihood of securing Spot instances which in turn, reduces cost.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-421-use-instancefleets-when-using-spot-instances">BP 4.2.1 Use Instancefleets when using Spot Instances<a href="#bp-421-use-instancefleets-when-using-spot-instances" class="hash-link" aria-label="Direct link to BP 4.2.1 Use Instancefleets when using Spot Instances" title="Direct link to BP 4.2.1 Use Instancefleets when using Spot Instances">​</a></h2>
<p>Instance Fleets provides clusters with flexibility - instead of relying on a single instance type to reach your target capacity, you can specify up to 30 different types and families. This is a best practice when using Spot because EMR will automatically provision instances from the most-available Spot capacity pools when allocation strategy is enabled. Because your Spot Instance capacity is sourced from pools with optimal capacity, this decreases the possibility that your Spot Instances will be reclaimed. A good rule of thumb is to be flexible across at least 10 instance types for each workload. In addition, make sure that all Availability Zones are configured for use in your VPC and selected for your workload. An EMR cluster will only be provisioned in a single AZ but will look across all for the initial provisioning.</p>
<p>When using Instance Fleets, it is recommended you diversify across instances and family. For more details, see:</p>
<p>(<a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-flexibility.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-flexibility.html</a>)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-422-ensure-application-masters-only-run-on-an-on-demand-node">BP 4.2.2 Ensure Application Masters only run on an On Demand Node<a href="#bp-422-ensure-application-masters-only-run-on-an-on-demand-node" class="hash-link" aria-label="Direct link to BP 4.2.2 Ensure Application Masters only run on an On Demand Node" title="Direct link to BP 4.2.2 Ensure Application Masters only run on an On Demand Node">​</a></h2>
<p>When a job is submitted to EMR Prior to the 5.x release, the Application Master (AM) can run on any of the nodes*. The AM is is the main container requesting, launching and monitoring application specific resources. Each job launches a single AM and if the AM is assigned to a Spot node, and that Spot node is interrupted, your job will fail.</p>
<p>Therefore, it&#x27;s important to ensure the AM is as resilient as possible. Assuming you are running a mixed cluster of On Demand and Spot, by placing AM&#x27;s on On Demand nodes, you&#x27;ll ensure AM&#x27;s do not fail due to a Spot interruption.</p>
<p>The following uses <code>yarn.nodemanager.node-labels.provider.script.path</code> to run a script that sets node label to the market type - On Demand or Spot. <code>yarn-site</code> is also updated so that application masters are only assigned to the &quot;on_demand&quot; label. Finally, the cluster is updated to include the new node label.</p>
<p>This is a good option when you run a mix of On Demand and Spot. You can enable this with the following steps:</p>
<p>1. Save <code>getNodeLabels_bootstrap.sh</code> and <code>getNodeLabels.py</code> in S3 and run <code>getNodeLabels_bootstrap.sh</code> as an EMR bootstrap action</p>
<p><strong>getNodeLabels_bootstrap.sh</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws s3 cp s3://&lt;bucket&gt;/getNodeLabels.py /home/hadoop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x /home/hadoop/getNodeLabels.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This script will copy <code>getNodeLabels.py</code> onto each node which is used by YARN to set <code>NODE_PARTITION</code></p>
<p><strong>getNodeLabels.py</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k=&#x27;/mnt/var/lib/info/extraInstanceData.json&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with open(k) as f:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = json.load(f)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #print ((response[&#x27;instanceRole&#x27;],response[&#x27;marketType&#x27;]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (response[&#x27;instanceRole&#x27;] in [&#x27;core&#x27;,&#x27;task&#x27;] and response[&#x27;marketType&#x27;]==&#x27;on_demand&#x27;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       print (f&quot;NODE_PARTITION:{response[&#x27;marketType&#x27;].upper()}&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This script is run every time a node is provisioned and sets <code>NODE_PARTITION</code> to <code>on_demand</code>.</p>
<p>2. Set <code>yarn-site</code> classification to schedule AMs on <code>ON_DEMAND</code> nodes.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;classification&quot;:&quot;yarn-site&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Properties&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.nodemanager.node-labels.provider&quot;:&quot;script&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.nodemanager.node-labels.provider.script.path&quot;:&quot;/home/hadoop/getNodeLabels.py&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.node-labels.enabled&quot;:&quot;true&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.node-labels.am.default-node-label-expression&quot;:&quot;ON_DEMAND&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.nodemanager.node-labels.provider.configured-node-partition&quot;:&quot;ON_DEMAND,SPOT&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;classification&quot;:&quot;capacity-scheduler&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Properties&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.scheduler.capacity.root.accessible-node-labels.ON_DEMAND.capacity&quot;:&quot;100&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &quot;yarn.scheduler.capacity.root.default.accessible-node-labels.ON_DEMAND.capacity&quot;:&quot;100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3. Add EMR Step</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo -u yarn yarn rmadmin -addToClusterNodeLabels &quot;SPOT(exclusive=false),ON_DEMAND(exclusive=false)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This Step should be the first step on the EMR cluster, and adds the new node labels.</p>
<p>Once your cluster is provisioned, AM&#x27;s will only run on On Demand nodes. Other non AM containers will run on all nodes.</p>
<p>* EMR 5.19 and later uses the node label feature to assign AMs on core nodes only. Beginning with Amazon EMR 6.x release series, the YARN node labels feature is disabled by default. The application master processes can run on both core and task nodes by default.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-423-allow-application-masters-am-to-run-on-all-nodes">BP 4.2.3 Allow application masters (AM) to run on all nodes<a href="#bp-423-allow-application-masters-am-to-run-on-all-nodes" class="hash-link" aria-label="Direct link to BP 4.2.3 Allow application masters (AM) to run on all nodes" title="Direct link to BP 4.2.3 Allow application masters (AM) to run on all nodes">​</a></h2>
<p>With EMR 5.x, AM only run on core nodes. Because Spot Instances are often used to run task nodes, it prevents applications from failing in case an AM is assigned to a Spot node.</p>
<p>As a result of this, in scenarios where applications are occupying the full core node capacity, AM&#x27;s will be in a PENDING state since they can only run on core nodes. The application will have to wait for capacity to be available on the core nodes even if there&#x27;s capacity on the task  nodes.</p>
<p>Allowing AM&#x27;s to run on all nodes is a good option if you are not using Spot, or run a small number of core nodes and do not want your cluster to be limited by Core capacity. You can disable this behavior with the bootstrap action below:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;backup original init.pp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo cp cp /var/aws/emr/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp /tmp/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;replacing node label check&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo sed -i &#x27;/add-to-cluster-node-labels.*/,+5d&#x27; /var/aws/emr/bigtop-deploy/puppet/modules/hadoop/manifests/init.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Beginning with Amazon EMR 6.x release series, the YARN node labels feature is disabled by default. The AM processes can run on both core and task nodes by default. You can enable the YARN node labels feature by configuring following properties:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yarn.node-labels.enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yarn.node-labels.am.default-node-label-expression: &#x27;CORE&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When you allow AM&#x27;s to run on all nodes and are using managed scaling, consider increasing <code>yarn.resourcemanager.nodemanager-graceful-decommission-timeout-secs</code> so AM&#x27;s are not automatically terminated after the 1hr timeout in the event of a scale down. See BP 4.1.3 for more details.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-424-reserve-core-nodes-for-only-application-masters-am">BP 4.2.4 Reserve core nodes for only application masters (am)<a href="#bp-424-reserve-core-nodes-for-only-application-masters-am" class="hash-link" aria-label="Direct link to BP 4.2.4 Reserve core nodes for only application masters (am)" title="Direct link to BP 4.2.4 Reserve core nodes for only application masters (am)">​</a></h2>
<p>This is not necessarily related to Spot, but An alternative to BP 4.2.2 is to reserve core nodes for only application masters/spark drivers. This means tasks spawned from executors or AMs will only run on the task nodes. The approach keeps the “CORE” label for core nodes and specifies it as <code>exclusive=true</code>. This means that containers will only be allocated to CORE nodes when it matches the node partition during job submission. By default, EMR will set AM=Core and as long as users are not specifying node label = core, all containers will run on task.</p>
<p>Add EMR step during EMR provisioning:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#Change core label from exclusive=false to exclusive=true.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo -u yarn yarn rmadmin -removeFromClusterNodeLabels &quot;CORE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo -u yarn yarn rmadmin -addToClusterNodeLabels &quot;CORE(exclusive=true)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Applications can still be waiting for resources if the # of jobs you’re submitting exceeds the available space on your core nodes. However, this is less likely to occur now that tasks cant be assigned to core. Another other option to consider is allowing AM to run on all nodes but OD, but we do not recommend having AM run on the task group generally.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-425-reduce-spot-interruptions-by-setting-purchase-option-to-use-on-demand-as-max-price">BP 4.2.5 Reduce Spot interruptions by setting purchase Option to &quot;Use on-demand as max price&quot;<a href="#bp-425-reduce-spot-interruptions-by-setting-purchase-option-to-use-on-demand-as-max-price" class="hash-link" aria-label="Direct link to BP 4.2.5 Reduce Spot interruptions by setting purchase Option to &quot;Use on-demand as max price&quot;" title="Direct link to BP 4.2.5 Reduce Spot interruptions by setting purchase Option to &quot;Use on-demand as max price&quot;">​</a></h2>
<p>By setting the spot purchase option to &quot;use on-demand as max price&quot;, your Spot nodes will only be interrupted when EC2 takes back Spot capacity and not because of someone outbidding your Spot price.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-426-reduce-the-impact-of-spot-interruptions">BP 4.2.6 Reduce the impact of Spot interruptions<a href="#bp-426-reduce-the-impact-of-spot-interruptions" class="hash-link" aria-label="Direct link to BP 4.2.6 Reduce the impact of Spot interruptions" title="Direct link to BP 4.2.6 Reduce the impact of Spot interruptions">​</a></h2>
<p>There are a few strategies to consider when using Spot Instances that will help you take advantage of Spot pricing while still getting capacity:</p>
<ol>
<li><a href="https://aws.github.io/aws-emr-best-practices/cost_optimization/best_practices/#bp-19-mix-on-demand-and-spot-instances" target="_blank" rel="noopener noreferrer">Mix On Demand nodes with Spot</a></li>
<li><a href="https://aws.github.io/aws-emr-best-practices/reliability/best_practices/#bp-25-use-on-demand-for-core-nodes-and-spot-for-task" target="_blank" rel="noopener noreferrer">Use On Demand for core nodes and Spot for task</a></li>
<li>Reduce provisioning timeout and switch to On Demand - When using Instance Fleets, EMR allows you to set a timeout duration for getting Spot capacity. Once the duration is hit, you can choose to terminate the cluster or fall back to on demand. The default value is 60min but consider lowering this quickly fall back to on demand when spot is not available</li>
<li>Checkpoint often - This allows you to retry from a certain part of your pipeline if you ever lose too many Spot nodes</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bp-427-adjust-spark-task-size-to-complete-within-2-minutes">BP 4.2.7 Adjust Spark task size to complete within 2 minutes<a href="#bp-427-adjust-spark-task-size-to-complete-within-2-minutes" class="hash-link" aria-label="Direct link to BP 4.2.7 Adjust Spark task size to complete within 2 minutes" title="Direct link to BP 4.2.7 Adjust Spark task size to complete within 2 minutes">​</a></h2>
<p>Consider reducing spark task sizes to minimize the impact of a Spot interruption. Smaller task sizes complete faster. These tasks will be less impacted by spot because the amount of time to recompute the failed task is less. There are a number of factors that impact the # of spark tasks and their run time such as <code>spark.sql.files.maxPartitionBytes</code>, <code>spark.default.parallelism</code>, # of objects in S3, or are the objects can be split. See Spark best practices section on how to adjust task run times.</p>
<p>When using Spot, the optimal task run time is less than 2 minutes. This is because EC2 Spot instances receive a two-minute warning when these instances are about to be reclaimed by Amazon EC2 which means most tasks will be able to finish before the spot node is reclaimed. In addition, EMR does not assign new tasks to nodes that have received the 2 minute warning.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/bestpractices/4 - Features/Spot Usage/best_practices.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aws-emr-best-practices/docs/bestpractices/Features/Managed Scaling/best_practices"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Best Practices</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aws-emr-best-practices/docs/bestpractices/Applications/Hbase/introduction"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bp-421-when-to-use-spot-vs-on-demand" class="table-of-contents__link toc-highlight">BP 4.2.1 When to use spot vs. on demand</a></li><li><a href="#bp-421-use-instancefleets-when-using-spot-instances" class="table-of-contents__link toc-highlight">BP 4.2.1 Use Instancefleets when using Spot Instances</a></li><li><a href="#bp-422-ensure-application-masters-only-run-on-an-on-demand-node" class="table-of-contents__link toc-highlight">BP 4.2.2 Ensure Application Masters only run on an On Demand Node</a></li><li><a href="#bp-423-allow-application-masters-am-to-run-on-all-nodes" class="table-of-contents__link toc-highlight">BP 4.2.3 Allow application masters (AM) to run on all nodes</a></li><li><a href="#bp-424-reserve-core-nodes-for-only-application-masters-am" class="table-of-contents__link toc-highlight">BP 4.2.4 Reserve core nodes for only application masters (am)</a></li><li><a href="#bp-425-reduce-spot-interruptions-by-setting-purchase-option-to-use-on-demand-as-max-price" class="table-of-contents__link toc-highlight">BP 4.2.5 Reduce Spot interruptions by setting purchase Option to &quot;Use on-demand as max price&quot;</a></li><li><a href="#bp-426-reduce-the-impact-of-spot-interruptions" class="table-of-contents__link toc-highlight">BP 4.2.6 Reduce the impact of Spot interruptions</a></li><li><a href="#bp-427-adjust-spark-task-size-to-complete-within-2-minutes" class="table-of-contents__link toc-highlight">BP 4.2.7 Adjust Spark task size to complete within 2 minutes</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get Involved</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/aws/aws-emr-best-practices/tree/main" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS  <br> © 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer></div>
</body>
</html>