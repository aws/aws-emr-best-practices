<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-bestpractices/Applications/Spark/best_practices" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Best Practices | AWS Open Data Analytics</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" name="twitter:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" property="og:url" content="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Best Practices | AWS Open Data Analytics"><meta data-rh="true" name="description" content="Use the most recent version of EMR"><meta data-rh="true" property="og:description" content="Use the most recent version of EMR"><link data-rh="true" rel="canonical" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-MF59LKNSDN","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/aws-emr-best-practices/assets/css/styles.28ef5182.css">
<script src="/aws-emr-best-practices/assets/js/runtime~main.61a46e42.js" defer="defer"></script>
<script src="/aws-emr-best-practices/assets/js/main.82d975cf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aws-emr-best-practices/"><b class="navbar__title text--truncate">AWS Open Data Analytics</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aws-emr-best-practices/docs/bestpractices/introduction">Best Practices</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/benchmarks/introduction">Benchmarks</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/migration/introduction">Migration</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/utilities/introduction">Utilities</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aws-emr-best-practices/docs/bestpractices/introduction">EMR Best Practices</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/aws-emr-best-practices/docs/bestpractices/Applications/HBase/introduction">Applications</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/HBase/introduction">HBase</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Hadoop/introduction">Hadoop</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Hive/introduction">Hive</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/introduction">Spark</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices">Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/data_quality">Data Quality</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/data_skew">Data Skew</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/joins">Join Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/performance">Performance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/thrift">Thrift Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/troubleshooting">Troubleshooting</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/Introduction">Cost Optimizations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Features/EMRFS/aimd">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Observability/best_practices">Observability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Reliability/introduction">Reliability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Security/introduction">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Troubleshooting/Troubleshooting EMR">Troubleshooting</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aws-emr-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Applications</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spark</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Best Practices</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Best Practices</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-the-most-recent-version-of-emr">Use the most recent version of EMR<a href="#use-the-most-recent-version-of-emr" class="hash-link" aria-label="Direct link to Use the most recent version of EMR" title="Direct link to Use the most recent version of EMR">​</a></h2>
<p>Amazon EMR provides several Spark optimizations out of the box with <a href="https://aws.amazon.com/blogs/big-data/run-apache-spark-3-0-workloads-1-7-times-faster-with-amazon-emr-runtime-for-apache-spark/" target="_blank" rel="noopener noreferrer">EMR Spark runtime</a> which is 100% compliant with the open source Spark APIs i.e., EMR Spark does not require you to configure anything or change your application code. We continue to <a href="https://aws.amazon.com/about-aws/whats-new/2021/10/amazon-emr-6-4-supports-apache-spark-3-1-2/" target="_blank" rel="noopener noreferrer">improve</a> the performance of this Spark runtime engine for new releases. Several <a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-spark-performance.html" target="_blank" rel="noopener noreferrer">optimizations</a> such as Adaptive Query Execution are only available from EMR 5.30 and 6.0 versions onwards. For example, following image shows the Spark runtime performance improvements in EMR 6.5.0 (latest version as of writing this) compared to its previous version EMR 6.1.0 based on a derived TPC-DS benchmark test performed on two identical EMR clusters with same hardware and software configurations (except for the version difference).</p>
<p><img decoding="async" loading="lazy" alt="BP - 33" src="/aws-emr-best-practices/assets/images/spark-bp-33-4ce8c6991aac1dde4636a948b1c4d96c.png" width="752" height="449" class="img_ev3q"></p>
<p>As seen in the above image, Spark runtime engine on EMR 6.5.0 is 1.9x faster by geometric mean compared to EMR 6.1.0. Hence, it is strongly recommended to migrate or upgrade to the latest available Amazon EMR version to make use of all these performance benefits.</p>
<p>Upgrading to a latest EMR version is typically a daunting task - especially major upgrades (for eg: migrating to Spark 3.1 from Spark 2.4). In order to reduce the upgrade cycles, you can make use of <a href="https://aws.amazon.com/emr/serverless/" target="_blank" rel="noopener noreferrer">EMR Serverless</a> (in preview) to quickly run your application in an upgraded version without worrying about the underlying infrastructure. For example, you can create an EMR Serverless Spark application for EMR release label 6.5.0 and submit your Spark code.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-serverless create-application \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --release-label emr-6.5.0-preview   \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --type &#x27;SPARK&#x27;                      \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name spark-6.5.0-demo-application \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --region us-east-1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Detailed documentation for running Spark jobs using EMR Serverless can be found <a href="https://docs.aws.amazon.com/emr/latest/EMR-Serverless-UserGuide/spark-jobs.html" target="_blank" rel="noopener noreferrer">here</a>. Since EMR Serverless and EMR on EC2 will use the same Spark runtime engine for a given EMR release label, once your application runs successfully in EMR Serverless, you can easily port your application code to the same release version on EMR. Please note that this approach does not factor in variables due to infrastructure or deployment into consideration and is only meant to validate your application code quickly on an upgraded Spark version in the latest Amazon EMR release available.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="choose-the-right-hardware-for-your-workloads">Choose the right hardware for your workloads<a href="#choose-the-right-hardware-for-your-workloads" class="hash-link" aria-label="Direct link to Choose the right hardware for your workloads" title="Direct link to Choose the right hardware for your workloads">​</a></h2>
<p>Spark workloads may require different types of hardware for different job characteristics to ensure optimal performance. EMR supports <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-supported-instance-types.html" target="_blank" rel="noopener noreferrer">several instance types</a> to cover all types of processing requirements. While onboarding new workloads, it is recommended to start benchmarking with general instance types like <code>m5</code> or <code>m6g</code>. Monitor the OS and YARN metrics from Ganglia and CloudWatch to determine the system bottlenecks at peak load. Bottlenecks include CPU, memory, storage and I/O. Once identified, choose the appropriate hardware type for your job requirements.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-optimized">Memory-optimized<a href="#memory-optimized" class="hash-link" aria-label="Direct link to Memory-optimized" title="Direct link to Memory-optimized">​</a></h3>
<p>Memory-optimized instances such as <code>r5</code> and <code>r4</code> are ideal choices for memory-intensive workloads. Workloads that involve caching large DataFrames, Datasets, or RDDs in Apache Spark; performing complex join, union, or other data manipulation tasks on extensive tables; utilizing numerous internal or custom broadcast variables or accumulators; undergoing multiple garbage collection (GC) cycles; and executing significant data shuffling processes typically fall into this category. The following diagram illustrates the percentage of YARN memory used and the corresponding aggregate OS memory consumption from Amazon EMR&#x27;s CloudWatch namespace and Ganglia, respectively:</p>
<p><img decoding="async" loading="lazy" alt="BP - 1" src="/aws-emr-best-practices/assets/images/spark-bp-1-d68f174e99abf50f88900af503961459.png" width="724" height="946" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cpu-optimized">CPU-optimized<a href="#cpu-optimized" class="hash-link" aria-label="Direct link to CPU-optimized" title="Direct link to CPU-optimized">​</a></h3>
<p>CPU-optimized instances, such as <code>c5</code> and <code>c4</code>, are ideal choices for CPU-intensive workloads. Tasks like Spark jobs with intricate aggregate operations employing numerous built-in mathematical functions or User Defined Functions (UDFs), along with those utilizing extensive LRU caches, tend to be computationally demanding. The subsequent screenshot illustrates the accumulated CPU usage of an EMR cluster derived from Ganglia.</p>
<p><img decoding="async" loading="lazy" alt="BP - 2" src="/aws-emr-best-practices/assets/images/spark-bp-2-62ac31475da4916a2887ff0cf63c657d.png" width="822" height="478" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="general-purpose">General purpose<a href="#general-purpose" class="hash-link" aria-label="Direct link to General purpose" title="Direct link to General purpose">​</a></h3>
<p>General purpose instances like <code>m5</code> and <code>m4</code> are good candidates for a mix of CPU and memory intensive workloads. They are also great for benchmarking and onboarding your Spark applications. Following sheet outlines the CPU<!-- -->:Memory<!-- --> ratio of 3 different instances types at a similar price. It is important to use instance types with right CPU<!-- -->:memory<!-- --> ratio based on your workload needs.</p>
<table><thead><tr><th>Instance Type</th><th>Instance</th><th>EC2 price</th><th>EMR price</th><th>Cores</th><th>Memory in GiB</th><th>CPU<!-- -->:memory<!-- --> ratio</th></tr></thead><tbody><tr><td>Compute</td><td>c5.18xlarge</td><td>$3.06</td><td>$0.27</td><td>72</td><td>144</td><td>2</td></tr><tr><td>Memory</td><td>r5.12xlarge</td><td>$3.02</td><td>$0.27</td><td>48</td><td>384</td><td>8</td></tr><tr><td>General</td><td>m5.16xlarge</td><td>$3.07</td><td>$0.27</td><td>64</td><td>256</td><td>4</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-optimized">Storage-optimized<a href="#storage-optimized" class="hash-link" aria-label="Direct link to Storage-optimized" title="Direct link to Storage-optimized">​</a></h3>
<p>Storage-optimized instances like <code>i3en</code>, <code>d2</code> are good candidates for I/O intensive workloads. If your use case is CPU/memory bound but also consumes a lot of I/O, and demands high disk throughput or low read or write latencies from transient HDFS storage, you can consider using instances backed by SSD volumes like <code>r5d</code>, <code>c5d</code>, <code>m5d</code> etc.. Spark jobs that perform massive shuffles may also benefit from instance types with optimized storage since Spark external shuffle service will write the shuffle data blocks to the local disks of worker nodes running the executors.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gpu-instances">GPU instances<a href="#gpu-instances" class="hash-link" aria-label="Direct link to GPU instances" title="Direct link to GPU instances">​</a></h3>
<p>GPU instances such as <code>p3</code> family are typically used for Spark ML and intensive analytical workloads like image processing. From EMR 6.2, you can make use of <a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-spark-rapids.html" target="_blank" rel="noopener noreferrer">Nvidia RAPIDS accelerator</a> plugin to improve your GPU instance performance without any changes to your code or data processing pipelines.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="graviton-instances">Graviton instances<a href="#graviton-instances" class="hash-link" aria-label="Direct link to Graviton instances" title="Direct link to Graviton instances">​</a></h3>
<p>Starting EMR 5.31+ and 6.1+, EMR supports Graviton instance (eg: <code>r6g</code>, <code>m6g</code>, <code>c6g</code>) which offers up to 15% improvement in performance and 30% reduction in cost based on our derived benchmark tests. They are a great choice to replace your legacy instances and achieve better price-performance.</p>
<p><img decoding="async" loading="lazy" alt="BP - 3" src="/aws-emr-best-practices/assets/images/spark-bp-3-433c6f0dee92f98974818ec632a7c8a0.png" width="1836" height="818" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="choose-the-right-deploy-mode">Choose the right deploy mode<a href="#choose-the-right-deploy-mode" class="hash-link" aria-label="Direct link to Choose the right deploy mode" title="Direct link to Choose the right deploy mode">​</a></h2>
<p>Spark provides two deployment modes: <code>client</code> and <code>cluster</code>. The choice of deployment mode in Spark determines where the Spark driver, which acts as the central control system for your Spark application, will run. The Spark driver plays a crucial role by managing the SparkContext (or SparkSession), monitoring task and executor status through heartbeats, and retrieving computation results from the executors. Select an appropriate deploy mode according to your specific workload needs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-deploy-mode">Client deploy mode<a href="#client-deploy-mode" class="hash-link" aria-label="Direct link to Client deploy mode" title="Direct link to Client deploy mode">​</a></h3>
<p>In client deployment mode for Spark applications (the default mode in an EMR on Ec2 cluster), the driver process runs inside the client submitting the application rather than on the cluster itself. This means that if you initiate the submission from an EMR master node via the EMR Step API or spark-submit, or even from a remote client, the Spark driver process will launch locally. However, it&#x27;s important to note that the Spark driver is now a potential single point of failure since there won&#x27;t be any automatic retrying of a failed driver process in client deployment mode. Additionally, should the client lose its connection to YARN, the associated job will be terminated.</p>
<p><img decoding="async" loading="lazy" alt="BP - 4" src="/aws-emr-best-practices/assets/images/spark-bp-4-0ac9c7cc0bb2cff70ac01efa69455604.png" width="1576" height="712" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use">When to use<a href="#when-to-use" class="hash-link" aria-label="Direct link to When to use" title="Direct link to When to use">​</a></h4>
<ul>
<li>You are running only one or two Spark applications at a time in a cluster. This deploy mode is not ideal if you are running multiple applications at the same time on the same cluster since all those Spark drivers running on a single master/remote node can lead to resource contention.</li>
<li>You want to be more in control of your Spark driver configurations. In client mode, Spark driver resources will not compete with YARN resources and can be adjusted separately without affecting the YARN resource procurement of your applications.</li>
<li>You&#x27;re currently handling an excessive number of executors (over 1000) and tasks (more than 30000) within your Spark application. This could be causing performance issues due to the Spark driver being overwhelmed with monitoring and managing these processes. To mitigate this issue, consider allocating a more robust instance for your master node. By selecting a high-performance instance such as <code>z1d</code>, you can provide additional memory and CPU capabilities specifically for the Spark driver process that is responsible for overseeing numerous executors and tasks within your application.</li>
<li>You want to write output to the console i.e., send the results back to the client program where you submitted your application.</li>
<li>Notebook applications such as Jupyter, Zeppelin etc. will use client deploy mode.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-deploy-mode">Cluster deploy mode<a href="#cluster-deploy-mode" class="hash-link" aria-label="Direct link to Cluster deploy mode" title="Direct link to Cluster deploy mode">​</a></h3>
<p>In cluster deploy mode, your Spark driver will be located within the Application Master (AM) container from YARN regardless of where you submit your Spark application from.</p>
<p><img decoding="async" loading="lazy" alt="BP - 5" src="/aws-emr-best-practices/assets/images/spark-bp-5-2bc36e065f3f17ca9e604e73484b03d0.png" width="1470" height="762" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-1">When to use<a href="#when-to-use-1" class="hash-link" aria-label="Direct link to When to use" title="Direct link to When to use">​</a></h4>
<ul>
<li>You are submitting multiple applications at the same time or have higher application or EMR step concurrency. While running multiple applications, Spark drivers will be spread across the cluster since AM container from a single application will be launched on one of the worker nodes.</li>
<li>There are relatively fewer number of executors per application. i.e., the Spark driver process does not have to do intensive operations like manage and monitor tasks from too many executors.</li>
<li>You are saving results in S3/HDFS and there is no need to print output to the console.</li>
<li>You want to specify detailed instructions on where AM runs. You can launch AMs on CORE partition or both CORE and TASK partitions based on where you want your AM and executors to launch. For example, you can run AM on only on-demand CORE nodes and executors only on spot task nodes.</li>
<li>You want to relaunch a failed driver JVM i.e., increased resiliency. By default, YARN re-attempts AM loss twice based on property <em><code>spark.yarn.maxAppAttempts</code></em>. You can increase this value further if needed.</li>
<li>You want to ensure that termination of your Spark client will not lead to termination of your application. You can also have Spark client return success status right after the job submission if the property <em><code>spark.yarn.submit.waitAppCompletion</code></em> is set to &quot;false&quot;.</li>
</ul>
<p>Regardless of which deploy mode you choose, make sure that your driver Spark configs are tuned for your workload needs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="leverage-spot-nodes-with-managed-autoscaling">Leverage spot nodes with managed autoscaling<a href="#leverage-spot-nodes-with-managed-autoscaling" class="hash-link" aria-label="Direct link to Leverage spot nodes with managed autoscaling" title="Direct link to Leverage spot nodes with managed autoscaling">​</a></h2>
<p>Enable managed autoscaling for your EMR clusters. From EMR 5.32 and EMR 6.2, several optimizations have been made to managed scaling to make it more resilient for your Spark workloads. It is not recommended to use Spot with core or master nodes since during a Spot reclaimation event, your cluster could be terminated and you would need to re-process all the work. Try to leverage task instance fleets with many instance types per fleet along with Spot since it would give both cost and performance gains. However, in this case, make sure that your output is being written directly to S3 using EMRFS since we will aim to have limited/fixed core node capacity.</p>
<p>Following policy defines max core nodes to 2 and we are requesting the core nodes to be on-demand as recommended. Rest of the nodes are Spot task nodes.</p>
<p><img decoding="async" loading="lazy" alt="BP - 9" src="/aws-emr-best-practices/assets/images/spark-bp-9-369daec232c227dc85cec83855474988.png" width="766" height="494" class="img_ev3q"></p>
<p>Following experimentation illustrates the performance gains using Managed Autoscaling.</p>
<p><img decoding="async" loading="lazy" alt="BP - 10" src="/aws-emr-best-practices/assets/images/spark-bp-10-184ae0ba08403078004fe72e94783ad8.png" width="817" height="203" class="img_ev3q"></p>
<p>For some of our Spark workloads, we observed ~50% gains compared to custom autoscaling clusters. Please note that the results may vary for your workloads.</p>
<p><img decoding="async" loading="lazy" alt="BP - 11" src="/aws-emr-best-practices/assets/images/spark-bp-11-2a5fc7f91f958c598571794609f9a11b.png" width="817" height="233" class="img_ev3q"></p>
<p>If your workloads are SLA sensitive and fault intolerant, it is best to use on-demand nodes for task fleets as well since reclaimation of Spot may lead to re-computation of one or more stages or tasks.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/bestpractices/Applications/Spark/best_practices.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/data_quality"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Data Quality</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#use-the-most-recent-version-of-emr" class="table-of-contents__link toc-highlight">Use the most recent version of EMR</a></li><li><a href="#choose-the-right-hardware-for-your-workloads" class="table-of-contents__link toc-highlight">Choose the right hardware for your workloads</a><ul><li><a href="#memory-optimized" class="table-of-contents__link toc-highlight">Memory-optimized</a></li><li><a href="#cpu-optimized" class="table-of-contents__link toc-highlight">CPU-optimized</a></li><li><a href="#general-purpose" class="table-of-contents__link toc-highlight">General purpose</a></li><li><a href="#storage-optimized" class="table-of-contents__link toc-highlight">Storage-optimized</a></li><li><a href="#gpu-instances" class="table-of-contents__link toc-highlight">GPU instances</a></li><li><a href="#graviton-instances" class="table-of-contents__link toc-highlight">Graviton instances</a></li></ul></li><li><a href="#choose-the-right-deploy-mode" class="table-of-contents__link toc-highlight">Choose the right deploy mode</a><ul><li><a href="#client-deploy-mode" class="table-of-contents__link toc-highlight">Client deploy mode</a></li><li><a href="#cluster-deploy-mode" class="table-of-contents__link toc-highlight">Cluster deploy mode</a></li></ul></li><li><a href="#leverage-spot-nodes-with-managed-autoscaling" class="table-of-contents__link toc-highlight">Leverage spot nodes with managed autoscaling</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/aws/aws-emr-best-practices/tree/main" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS  <br> © 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer></div>
</body>
</html>