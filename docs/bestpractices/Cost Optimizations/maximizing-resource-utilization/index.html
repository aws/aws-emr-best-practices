<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-bestpractices/Cost Optimizations/maximizing-resource-utilization" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Optimizing Resource Utilization | AWS Open Data Analytics</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" name="twitter:image" content="https://aws.github.io/aws-emr-best-practices/img/AWS_logo_RGB.png"><meta data-rh="true" property="og:url" content="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Optimizing Resource Utilization | AWS Open Data Analytics"><meta data-rh="true" name="description" content="Cluster utilization in EMR refers to the effective use of computing resources, which include memory and CPU. The pricing structure for EMR on EC2 relies on resource usage such as CPU, memory, and disk. Ensuring optimal cluster utilization is crucial for getting the maximum value from the EMR cluster. To maintain high cluster utilization in EMR on EC2, it is essential to follow best practices. This includes configuring managed scaling, adjusting container sizes at the application level (requiring EMR observability setup), and selecting the right EC2 instance types, as explained in this document."><meta data-rh="true" property="og:description" content="Cluster utilization in EMR refers to the effective use of computing resources, which include memory and CPU. The pricing structure for EMR on EC2 relies on resource usage such as CPU, memory, and disk. Ensuring optimal cluster utilization is crucial for getting the maximum value from the EMR cluster. To maintain high cluster utilization in EMR on EC2, it is essential to follow best practices. This includes configuring managed scaling, adjusting container sizes at the application level (requiring EMR observability setup), and selecting the right EC2 instance types, as explained in this document."><link data-rh="true" rel="canonical" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws.github.io/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-MF59LKNSDN","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/aws-emr-best-practices/assets/css/styles.28ef5182.css">
<script src="/aws-emr-best-practices/assets/js/runtime~main.61a46e42.js" defer="defer"></script>
<script src="/aws-emr-best-practices/assets/js/main.82d975cf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/aws-emr-best-practices/"><b class="navbar__title text--truncate">AWS Open Data Analytics</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/aws-emr-best-practices/docs/bestpractices/introduction">Best Practices</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/benchmarks/introduction">Benchmarks</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/migration/introduction">Migration</a><a class="navbar__item navbar__link" href="/aws-emr-best-practices/docs/utilities/introduction">Utilities</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/aws-emr-best-practices/docs/bestpractices/introduction">EMR Best Practices</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Applications/HBase/introduction">Applications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/Introduction">Cost Optimizations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/Introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/best_practices">Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization">Optimizing Resource Utilization</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Features/EMRFS/aimd">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Observability/best_practices">Observability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Reliability/introduction">Reliability</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Security/introduction">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/aws-emr-best-practices/docs/bestpractices/Troubleshooting/Troubleshooting EMR">Troubleshooting</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/aws-emr-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Cost Optimizations</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Optimizing Resource Utilization</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Optimizing Resource Utilization</h1></header>
<p>Cluster utilization in EMR refers to the effective use of computing resources, which include memory and CPU. The pricing structure for EMR on EC2 relies on resource usage such as CPU, memory, and disk. Ensuring optimal cluster utilization is crucial for getting the maximum value from the EMR cluster. To maintain high cluster utilization in EMR on EC2, it is essential to follow best practices. This includes configuring managed scaling, adjusting container sizes at the application level (requiring EMR observability setup), and selecting the right EC2 instance types, as explained in this document.</p>
<p>This document provides insights on cluster utilization, covering actual memory and CPU usage, monitoring cluster utilization using Amazon CloudWatch, identifying key factors to maximize utilization, and troubleshooting underutilized clusters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="actual-ec2-instance-resource-usage-vs-yarn-allocated-resource-usage">Actual EC2 Instance Resource Usage vs. YARN Allocated Resource Usage<a href="#actual-ec2-instance-resource-usage-vs-yarn-allocated-resource-usage" class="hash-link" aria-label="Direct link to Actual EC2 Instance Resource Usage vs. YARN Allocated Resource Usage" title="Direct link to Actual EC2 Instance Resource Usage vs. YARN Allocated Resource Usage">​</a></h2>
<p>Actual EC2 Instance Resource Usage refers to the actual CPU, memory, and disk utilized by the EC2 instances hosting the YARN ResourceManager/NodeManagers. YARN Allocated Resource Usage refers to the resources allocated to YARN applications by the ResourceManager and NodeManagers based on the resource requests specified by the applications.</p>
<p>When the ResourceManager receives an application from a client, it launches the ApplicationMaster on a node and sends the information for application execution. The ApplicationMaster, after resource allocation from ResourceManager, communicates with NodeManagers on each node, launches containers (which consist of memory and CPU) on these instances, and executes the application.</p>
<p>The allocation of resources to YARN containers is defined by configurations specific to the processing frameworks utilized, such as <code>spark.executor.memory</code> and <code>spark.executor.cores</code> for Spark, <code>hive.tez.container.size</code> for Hive on Tez, and <code>mapreduce.map.memory.mb</code> and <code>mapreduce.reduce.memory.mb</code> for Hadoop MapReduce. Each framework has its default configurations defining the container size for its tasks, which can be customized by the user.</p>
<p>You can refer to our documentation for insights into the default configured resource allocation settings for YARN based on instance type at <a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-hadoop-task-config.html" target="_blank" rel="noopener noreferrer">AWS EMR Task Configuration</a>.</p>
<p>Alternatively, to understand the YARN resource allocation on your cluster instances, you can use the following command after SSHing into the node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ yarn node -list -showDetails</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="YARN Node List Details" src="/aws-emr-best-practices/assets/images/mru-1-1f253f202847475b24265ca81efdb1d8.png" width="1083" height="205" class="img_ev3q"></p>
<p>For example, consider the <code>r7g.2xlarge</code> instance type, which has 64 GiB (65,536 MiB) of memory and 8 cores. Out of this, EMR allocates 54,272 MiB to YARN.</p>
<p><img decoding="async" loading="lazy" alt="r7g.2xlarge Config Details" src="/aws-emr-best-practices/assets/images/mru-2-17247800ff7f7b61ff3cd4624fad9028.png" width="787" height="412" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="allocated-vs-utilized">Allocated vs. Utilized<a href="#allocated-vs-utilized" class="hash-link" aria-label="Direct link to Allocated vs. Utilized" title="Direct link to Allocated vs. Utilized">​</a></h3>
<p>If there is an overallocation of resources to YARN containers, such as allocating 4 GB to a YARN container while only 2 GB is actually used, the YARN cluster&#x27;s resource utilization will appear high. However, the overall OS-level resource utilization could remain normal. In this scenario, resizing the containers based on actual usage is necessary. Proper EMR observability setup, as detailed in this GitHub repository, is essential for gaining insights into the cluster&#x27;s state.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizing-cluster-utilization">Optimizing Cluster Utilization<a href="#optimizing-cluster-utilization" class="hash-link" aria-label="Direct link to Optimizing Cluster Utilization" title="Direct link to Optimizing Cluster Utilization">​</a></h2>
<p>To maintain high cluster utilization in EMR on EC2, follow best practices such as enabling managed scaling, configuring container sizes at the application level, leveraging heterogeneous executors when using instances with varying vCore-to-memory ratios, and choosing the right instance type.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-managed-scaling">Enabling Managed Scaling<a href="#enabling-managed-scaling" class="hash-link" aria-label="Direct link to Enabling Managed Scaling" title="Direct link to Enabling Managed Scaling">​</a></h3>
<p>Managed scaling allows you to automatically increase or decrease the number of instances or units in your cluster based on workload. Amazon EMR continuously evaluates cluster metrics to make scaling decisions that optimize clusters for cost and speed. More details about cluster metrics can be found <a href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-managed-scaling.html" target="_blank" rel="noopener noreferrer">here</a>. Managed scaling is available for clusters composed of either instance groups or instance fleets.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-to-use-managed-scaling">When to Use Managed Scaling<a href="#when-to-use-managed-scaling" class="hash-link" aria-label="Direct link to When to Use Managed Scaling" title="Direct link to When to Use Managed Scaling">​</a></h4>
<p>Managed Scaling is beneficial for clusters that meet the following criteria:</p>
<ul>
<li>
<p><strong>Periods of Low Demand</strong>: Managed scaling is advantageous for clusters experiencing changes in demand. During low demand, it reduces resource allocation to avoid unnecessary consumption, optimizing resource utilization and cost efficiency.</p>
</li>
<li>
<p><strong>Fluctuating Workload Patterns</strong>: Clusters with dynamic or unpredictable workloads benefit from managed scaling as it adjusts resource capacity according to evolving needs.</p>
</li>
<li>
<p><strong>Handling Multiple Jobs</strong>: Managed scaling helps clusters running multiple jobs by automatically adjusting capacity based on workload intensity, ensuring efficient resource utilization and preventing bottlenecks.</p>
</li>
</ul>
<p><strong>Note</strong>: Managed Scaling is not recommended for clusters with steady-state resource usage, where the cluster’s resource consumption remains relatively stable and predictable.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-managed-scaling-decides-if-a-scaling-action-is-needed">How Managed Scaling Decides if a Scaling Action is Needed<a href="#how-managed-scaling-decides-if-a-scaling-action-is-needed" class="hash-link" aria-label="Direct link to How Managed Scaling Decides if a Scaling Action is Needed" title="Direct link to How Managed Scaling Decides if a Scaling Action is Needed">​</a></h4>
<p>Using high-resolution metrics with data at a one-minute granularity, such as <code>YARNMemoryAvailablePercentage</code>, <code>ContainersPendingRatio</code>, <code>CapacityRemainingGB</code>, <code>HDFSUtilization</code>, <code>AppsPending</code>, and cluster size, the Managed Scaling algorithm decides whether to scale the cluster up or down. The EMR team consistently enhances and refines this algorithm.</p>
<p>Managed Scaling collects these metrics from the cluster to observe resource utilization and additional demands. It estimates the number of YARN containers that fit on a typical node in your cluster, called <code>ContainerPerUnit</code>. When the cluster is low on memory and applications are waiting for containers, Managed Scaling adds additional nodes based on the <code>ContainerPerUnit</code> and cluster configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimizing-resource-utilization-through-managed-scaling-adjustments">Optimizing Resource Utilization through Managed Scaling Adjustments<a href="#optimizing-resource-utilization-through-managed-scaling-adjustments" class="hash-link" aria-label="Direct link to Optimizing Resource Utilization through Managed Scaling Adjustments" title="Direct link to Optimizing Resource Utilization through Managed Scaling Adjustments">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-keep-core-nodes-constant-and-scale-with-only-task-nodes">1. Keep Core Nodes Constant and Scale with Only Task Nodes<a href="#1-keep-core-nodes-constant-and-scale-with-only-task-nodes" class="hash-link" aria-label="Direct link to 1. Keep Core Nodes Constant and Scale with Only Task Nodes" title="Direct link to 1. Keep Core Nodes Constant and Scale with Only Task Nodes">​</a></h4>
<p>Scaling with only task nodes improves the time for nodes to scale in and out because task nodes do not coordinate storage as part of HDFS. During scale-up, task nodes do not need to install data node daemons, and during scale-down, they do not need to rebalance HDFS blocks. This improvement reduces cost and improves performance. Keeping a static fleet of core nodes also avoids saturating the remaining nodes&#x27; disk volume during HDFS rebalance.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-selecting-the-appropriate-min-and-max-managed-scaling-configuration">2. Selecting the Appropriate Min and Max Managed Scaling Configuration<a href="#2-selecting-the-appropriate-min-and-max-managed-scaling-configuration" class="hash-link" aria-label="Direct link to 2. Selecting the Appropriate Min and Max Managed Scaling Configuration" title="Direct link to 2. Selecting the Appropriate Min and Max Managed Scaling Configuration">​</a></h4>
<p>Review your existing jobs or conduct a sample run to understand application usage patterns. Analyze resource utilization, including memory and CPU, and identify any bottlenecks during peak loads. This analysis will help determine the maximum and minimum values for Managed Scaling. For cost efficiency, set a smaller <code>maxCapacity</code> to distribute the workload over a longer runtime of a smaller cluster. For performance improvement, a higher <code>maxCapacity</code> avoids extended pending states for containers. Experiment with both <code>maxCapacity</code> and <code>minCapacity</code> to balance job runtime and cost/utilization.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-am-exclusivity-to-on-demandcore-nodes">3. AM Exclusivity to On-Demand/Core Nodes<a href="#3-am-exclusivity-to-on-demandcore-nodes" class="hash-link" aria-label="Direct link to 3. AM Exclusivity to On-Demand/Core Nodes" title="Direct link to 3. AM Exclusivity to On-Demand/Core Nodes">​</a></h4>
<p>The Application Master (AM) requests, launches, and monitors application-specific resources. If the AM container fails, the whole job fails. To mitigate the risk of Spot instance reclamation, allocate AMs on On-Demand nodes. Non-AM containers, such as executors, can be placed on Spot nodes to reduce costs. EMR 5.19 and later uses node labels to assign AMs to core nodes. For EMR 6.x, configure node labels to specify the market type as either On-Demand or Spot, and update <code>yarn-site</code> configuration to ensure AMs are assigned to the &quot;on_demand&quot; label.</p>
<p>Starting with EMR 7.2, Amazon EMR on EC2 introduced Application Master (AM) Label Awareness. Enable YARN node labeling to allocate AM containers exclusively to On-Demand nodes:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;Classification&quot;: &quot;yarn-site&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;Properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;yarn.node-labels.enabled&quot;: &quot;true&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;yarn.node-labels.am.default-node-label-expression&quot;: &quot;ON_DEMAND&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-spot-instance-usage-considerations">4) Spot Instance Usage Considerations<a href="#4-spot-instance-usage-considerations" class="hash-link" aria-label="Direct link to 4) Spot Instance Usage Considerations" title="Direct link to 4) Spot Instance Usage Considerations">​</a></h4>
<p>Consider using Spot instances for tasks that can be interrupted and resumed (interruption rates are extremely low) or for workloads that can exceed an SLA. Spot instances are also a good choice for testing and development workloads or when testing new applications.</p>
<p><strong>Avoid using Spot instances if:</strong></p>
<ul>
<li>Your workload requires predictable completion time or has strict SLA requirements.</li>
<li>Your workload has zero fault tolerance or recomputing tasks are expensive.</li>
</ul>
<p>To mitigate the effects of Spot interruptions, reserve core nodes exclusively for application masters. Use On-Demand instances for core nodes and Spot instances for task nodes. Use Instance Fleet with an allocation strategy for Spot usage to diversify across many different instances. Ensure that all Availability Zones within your VPC are configured and selected for your workload. Although the EMR cluster is provisioned in a single AZ, it will look across all for the initial provisioning.</p>
<p><strong>Note:</strong></p>
<ol>
<li>Amazon EMR managed scaling only works with YARN applications, such as Spark, Hadoop, Hive, and Flink. It does not support applications that are not based on YARN, such as Presto and HBase. This also implies it won’t work as expected if you are using external tools to consume all EC2 memory outside of YARN. YARN metrics play a critical role in determining managed scaling events.</li>
<li>To evaluate Managed Scaling effectiveness specifically, assess utilization for periods when <code>YARNMemoryAllocated</code> or <code>AppsRunning</code> is above zero.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tailored-optimization-strategies-for-specific-use-cases">Tailored Optimization Strategies for Specific Use-Cases<a href="#tailored-optimization-strategies-for-specific-use-cases" class="hash-link" aria-label="Direct link to Tailored Optimization Strategies for Specific Use-Cases" title="Direct link to Tailored Optimization Strategies for Specific Use-Cases">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-use-cases-involving-peak-and-non-peak-hours-in-a-long-running-cluster">1) Use Cases Involving Peak and Non-Peak Hours in a Long-Running Cluster<a href="#1-use-cases-involving-peak-and-non-peak-hours-in-a-long-running-cluster" class="hash-link" aria-label="Direct link to 1) Use Cases Involving Peak and Non-Peak Hours in a Long-Running Cluster" title="Direct link to 1) Use Cases Involving Peak and Non-Peak Hours in a Long-Running Cluster">​</a></h4>
<p>In use cases with distinct peak and non-peak hours, a uniform configuration for both maximum and minimum resources may not be effective. During peak hours, it might be beneficial to elevate the managed scaling minimum to reduce the time required for the cluster to scale up, which could be approximately 4 minutes or more. During non-peak hours, reduce the managed scaling minimum. This adjustment can be implemented using a custom script.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-use-cases-with-spiky-workloads">2) Use Cases with Spiky Workloads<a href="#2-use-cases-with-spiky-workloads" class="hash-link" aria-label="Direct link to 2) Use Cases with Spiky Workloads" title="Direct link to 2) Use Cases with Spiky Workloads">​</a></h4>
<p>In scenarios with spiky workloads (characterized by sudden spikes in resource requirements for a short time), clusters frequently scale to their maximum capacity, even when the job may not need all the provisioned resources. This inefficiency arises because instances are provisioned after a substantial portion of the job is already completed. By the time these instances are up and running, the job no longer requires the new scaled-up resources. Use the MS Dampener script for a gradual and configurable scaling approach, ensuring more efficient resource utilization.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-use-cases-with-recurring-jobs">3) Use Cases with Recurring Jobs<a href="#3-use-cases-with-recurring-jobs" class="hash-link" aria-label="Direct link to 3) Use Cases with Recurring Jobs" title="Direct link to 3) Use Cases with Recurring Jobs">​</a></h4>
<p>Evaluate whether Managed Scaling aligns with your workload’s characteristics. Consider factors such as the predictability of resource usage and the potential cost savings versus the overhead (including the time it takes for a node to become available and accept resources when scaling up) of managing scaling policies. If your workload has consistent resource requirements, disabling Managed Scaling may be appropriate. However, if your workload experiences fluctuations in resource demand, enabling Managed Scaling with appropriate minimum and maximum values is recommended.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adjusting-container-sizes-at-the-application-level">Adjusting Container Sizes at the Application Level<a href="#adjusting-container-sizes-at-the-application-level" class="hash-link" aria-label="Direct link to Adjusting Container Sizes at the Application Level" title="Direct link to Adjusting Container Sizes at the Application Level">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="spark">Spark<a href="#spark" class="hash-link" aria-label="Direct link to Spark" title="Direct link to Spark">​</a></h4>
<p>As previously mentioned, configuration settings for resource allocation to YARN containers are specific to processing frameworks such as Spark. Generally, default configurations set by EMR are sufficient for most workloads. A YARN container represents a collection of resources, including CPU and memory. Each Spark executor operates within a YARN container. Spark applications consist of tasks executed by these executors, which are JVM processes running on cluster nodes.</p>
<p>To achieve optimal utilization initially, ensure that the total number of executors capable of running on a node can fully utilize the resources allocated to the YARN NodeManager. It is recommended to set <code>spark.executor.cores</code> to 4 or 5 and adjust <code>spark.executor.memory</code> accordingly. When calculating <code>spark.executor.memory</code>, consider the executor overhead, which defaults to 0.1875 (i.e., 18.75% of <code>spark.executor.memory</code>).</p>
<p>For more details on tuning Spark applications, refer to the <a href="/aws-emr-best-practices/docs/bestpractices/Applications/Spark/best_practices">EMR Best Practices Guide for Spark Applications</a>.</p>
<p>If you are diversifying instance types, ensure that you set the configuration parameter <code>spark.yarn.heterogeneousExecutors.enabled</code> to <code>true</code> (which is the default). If you are using the same instance types or a combination with similar vCPUs to memory ratios, you can set it to <code>false</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="selecting-the-right-ec2-instance-type">Selecting the Right EC2 Instance Type<a href="#selecting-the-right-ec2-instance-type" class="hash-link" aria-label="Direct link to Selecting the Right EC2 Instance Type" title="Direct link to Selecting the Right EC2 Instance Type">​</a></h3>
<p>To optimize cluster utilization, conduct benchmarking to identify the ideal instance type that aligns with your application&#x27;s requirements. Start with general instance types like <code>m6gs</code> or <code>m7gs</code> and monitor the OS and YARN metrics from CloudWatch to determine system bottlenecks at peak load, including CPU, memory, storage, and I/O. Determine the optimal vCPUs to memory ratio for your workload, identifying whether CPU-intensive, memory-intensive, or general-purpose instances best suit your use case.</p>
<p>For I/O intensive workloads, use storage-optimized instance types like <code>i3ens</code> or <code>d2</code>. For Spark ML and intensive analytical workloads, such as image processing, use GPU instances like <code>p3</code>.</p>
<p>Choosing a larger instance type offers advantages like increased efficiency in data shuffling due to fewer nodes but may be less efficient for single-task long-running stages. Conversely, small nodes are advantageous for scenarios with small tasks but employing many small nodes may be inefficient for shuffling large volumes of data.</p>
<p>Once you identify the most suitable instance type, for memory/CPU-intensive workloads (common in many big data use cases), consider using the latest generation EC2 Graviton instance types for better compute performance and price performance. Note that experience may differ with Spot instances due to potential high demand and increased spot prices.</p>
<p>When using instance fleets, select all instance types with similar vCPUs to memory ratios to ensure higher utilization even when diversifying instance types, contributing to better cluster utilization.</p>
<p>Typically, a smaller instance type is sufficient for the primary node of an EMR cluster, as its role is to serve clients, orchestrate tasks, and distribute them among core and task nodes.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/bestpractices/Cost Optimizations/maximizing-resource-utilization.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/aws-emr-best-practices/docs/bestpractices/Cost Optimizations/best_practices"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Best Practices</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/aws-emr-best-practices/docs/bestpractices/Features/EMRFS/aimd"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AIMD Retry Strategy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#actual-ec2-instance-resource-usage-vs-yarn-allocated-resource-usage" class="table-of-contents__link toc-highlight">Actual EC2 Instance Resource Usage vs. YARN Allocated Resource Usage</a><ul><li><a href="#allocated-vs-utilized" class="table-of-contents__link toc-highlight">Allocated vs. Utilized</a></li></ul></li><li><a href="#optimizing-cluster-utilization" class="table-of-contents__link toc-highlight">Optimizing Cluster Utilization</a><ul><li><a href="#enabling-managed-scaling" class="table-of-contents__link toc-highlight">Enabling Managed Scaling</a></li><li><a href="#optimizing-resource-utilization-through-managed-scaling-adjustments" class="table-of-contents__link toc-highlight">Optimizing Resource Utilization through Managed Scaling Adjustments</a></li><li><a href="#tailored-optimization-strategies-for-specific-use-cases" class="table-of-contents__link toc-highlight">Tailored Optimization Strategies for Specific Use-Cases</a></li><li><a href="#adjusting-container-sizes-at-the-application-level" class="table-of-contents__link toc-highlight">Adjusting Container Sizes at the Application Level</a></li><li><a href="#selecting-the-right-ec2-instance-type" class="table-of-contents__link toc-highlight">Selecting the Right EC2 Instance Type</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contributing</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/aws/aws-emr-best-practices/tree/main" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS  <br> © 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer></div>
</body>
</html>